# PDF Export Specification

## Overview

All content generated by the RAG system will be in **markdown format** designed for professional PDF conversion. This document specifies the structure and formatting requirements.

## Output Format

### Primary Format: Markdown
All generators output pure markdown with:
- Standard headers (#, ##, ###)
- Lists (ordered and unordered)
- Tables (markdown tables)
- Bold/italic emphasis
- Blockquotes
- Horizontal rules (---)

### Document Structure

```markdown
# Brand Strategy Document
**Client**: [Client Name]
**Generated**: [Date]

---

# Part 1: Understanding the Business

## Business Overview
[Content]

## Unique Value Proposition
[Content]

---

# Part 2: Target Audience Analysis

## Persona 1: [Name]
[Content]

## Persona 2: [Name]
[Content]

---

# Part 3: Industry Overview

## Competitive Landscape
[Table]

## Analysis
[Content]

---

# Part 4: Priority Competitor Analysis

## Competitor 1: @handle
[Content]

---

# Part 5: Content Analysis & Playbook

## Top Posts
[Content]

## Playbook
[Content]

---

# Appendix

## Data Quality Report
- Overall Score: [X]/100
- Business Data: [X]/100
- Competitor Data: [X]/100
- AI Insights: [X]/100

## Data Sources
- Research Job ID: [ID]
- Generated: [Timestamp]
- Generator Version: [Version]
```

## PDF Conversion Stack

### Option 1: Markdown-PDF (Node.js)
```typescript
import markdownPdf from 'markdown-pdf';

const options = {
  paperFormat: 'A4',
  paperOrientation: 'portrait',
  paperBorder: '1cm',
  cssPath: './pdf-styles.css'
};

markdownPdf(options)
  .from(markdownContent)
  .to('brand-strategy.pdf', callback);
```

### Option 2: Puppeteer + Marked
```typescript
import puppeteer from 'puppeteer';
import { marked } from 'marked';

const html = `
<!DOCTYPE html>
<html>
<head><link rel="stylesheet" href="pdf-styles.css"></head>
<body>${marked(markdownContent)}</body>
</html>
`;

const browser = await puppeteer.launch();
const page = await browser.newPage();
await page.setContent(html);
await page.pdf({
  path: 'brand-strategy.pdf',
  format: 'A4',
  printBackground: true
});
```

### Option 3: Pandoc (Most Flexible)
```bash
pandoc strategy.md \
  -o strategy.pdf \
  --pdf-engine=xelatex \
  --template=custom-template.tex \
  --toc \
  --number-sections \
  -V geometry:margin=1in
```

## Styling Requirements

### PDF Styles (CSS)

```css
/* pdf-styles.css */

/* Page setup */
@page {
  size: A4;
  margin: 2cm;
}

/* Headers */
h1 {
  font-size: 28px;
  font-weight: bold;
  color: #1a1a1a;
  margin-top: 40px;
  margin-bottom: 20px;
  page-break-before: always;
  border-bottom: 3px solid #333;
  padding-bottom: 10px;
}

h2 {
  font-size: 22px;
  font-weight: bold;
  color: #333;
  margin-top: 30px;
  margin-bottom: 15px;
}

h3 {
  font-size: 18px;
  font-weight: 600;
  color: #555;
  margin-top: 20px;
  margin-bottom: 10px;
}

/* Body text */
body {
  font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
  font-size: 11pt;
  line-height: 1.6;
  color: #333;
}

/* Lists */
ul, ol {
  margin-left: 20px;
  margin-bottom: 15px;
}

li {
  margin-bottom: 5px;
}

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 10pt;
}

th {
  background-color: #f0f0f0;
  font-weight: bold;
  padding: 10px;
  text-align: left;
  border: 1px solid #ddd;
}

td {
  padding: 8px;
  border: 1px solid #ddd;
}

/* Blockquotes */
blockquote {
  border-left: 4px solid #ccc;
  padding-left: 15px;
  margin-left: 0;
  font-style: italic;
  color: #666;
}

/* Code/emphasis */
code {
  background-color: #f5f5f5;
  padding: 2px 5px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 10pt;
}

strong {
  font-weight: 600;
  color: #1a1a1a;
}

/* Page breaks */
.page-break {
  page-break-after: always;
}

/* Cover page */
.cover {
  text-align: center;
  padding: 100px 0;
}

.cover h1 {
  font-size: 36px;
  border: none;
  page-break-before: avoid;
}

/* Table of contents */
.toc {
  page-break-after: always;
}

.toc ul {
  list-style: none;
}

.toc a {
  text-decoration: none;
  color: #333;
}
```

## Database Schema for PDF Storage

```typescript
// Add to schema.prisma

model StrategyDocument {
  id              String   @id @default(uuid())
  researchJobId   String   @unique @map("research_job_id")
  
  // Generated content (markdown)
  businessUnderstanding    String @db.Text @map("business_understanding")
  targetAudience           String @db.Text @map("target_audience")
  industryOverview         String @db.Text @map("industry_overview")
  priorityCompetitorAnalysis String @db.Text @map("priority_competitor_analysis")
  contentAnalysis          String @db.Text @map("content_analysis")
  
  // PDF metadata
  pdfGeneratedAt  DateTime? @map("pdf_generated_at")
  pdfUrl          String?   @map("pdf_url") // Cloud storage URL
  pdfSizeBytes    Int?      @map("pdf_size_bytes")
  
  // Generation metadata
  generationStatus  String  @default("PENDING") @map("generation_status")
  validationScores  Json?   @map("validation_scores")
  tokensUsed        Int?    @map("tokens_used")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  researchJob ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  
  @@map("strategy_documents")
}
```

## PDF Generation Service

```typescript
// apps/backend/src/services/pdf/strategy-pdf-generator.ts

import { marked } from 'marked';
import puppeteer from 'puppeteer';
import fs from 'fs';
import path from 'path';

interface StrategyContent {
  businessUnderstanding: string;
  targetAudience: string;
  industryOverview: string;
  priorityCompetitorAnalysis: string;
  contentAnalysis: string;
  clientName: string;
  generatedDate: string;
  qualityScores: Record<string, number>;
}

export async function generateStrategyPDF(
  content: StrategyContent,
  outputPath: string
): Promise<{ success: boolean; filePath: string; sizeBytes: number }> {
  
  // Combine all sections
  const fullMarkdown = `
# Brand Strategy Document

**Client**: ${content.clientName}  
**Generated**: ${content.generatedDate}

---

${content.businessUnderstanding}

---

${content.targetAudience}

---

${content.industryOverview}

---

${content.priorityCompetitorAnalysis}

---

${content.contentAnalysis}

---

# Appendix

## Data Quality Report
${Object.entries(content.qualityScores)
  .map(([key, score]) => `- ${key}: ${score}/100`)
  .join('\n')}
`;

  // Convert markdown to HTML
  const htmlContent = marked(fullMarkdown);
  
  // Load CSS
  const cssPath = path.join(__dirname, 'pdf-styles.css');
  const css = fs.readFileSync(cssPath, 'utf8');
  
  // Create full HTML
  const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>${css}</style>
</head>
<body>${htmlContent}</body>
</html>
  `;
  
  // Generate PDF with Puppeteer
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox']
  });
  
  const page = await browser.newPage();
  await page.setContent(html, { waitUntil: 'networkidle0' });
  
  await page.pdf({
    path: outputPath,
    format: 'A4',
    printBackground: true,
    margin: {
      top: '2cm',
      right: '2cm',
      bottom: '2cm',
      left: '2cm'
    }
  });
  
  await browser.close();
  
  // Get file size
  const stats = fs.statSync(outputPath);
  
  return {
    success: true,
    filePath: outputPath,
    sizeBytes: stats.size
  };
}
```

## Export API Endpoint

```typescript
// apps/backend/src/routes/strategy-export.ts

import { Router } from 'express';
import { generateStrategyPDF } from '../services/pdf/strategy-pdf-generator';
import { PrismaClient } from '@prisma/client';

const router = Router();
const prisma = new PrismaClient();

router.post('/api/research-jobs/:id/export-pdf', async (req, res) => {
  try {
    const { id } = req.params;
    
    // Get strategy document
    const doc = await prisma.strategyDocument.findUnique({
      where: { researchJobId: id },
      include: { researchJob: { include: { client: true } } }
    });
    
    if (!doc) {
      return res.status(404).json({ error: 'Strategy document not found' });
    }
    
    // Generate PDF
    const outputPath = `/tmp/strategy-${id}.pdf`;
    
    const result = await generateStrategyPDF({
      businessUnderstanding: doc.businessUnderstanding,
      targetAudience: doc.targetAudience,
      industryOverview: doc.industryOverview,
      priorityCompetitorAnalysis: doc.priorityCompetitorAnalysis,
      contentAnalysis: doc.contentAnalysis,
      clientName: doc.researchJob.client.name,
      generatedDate: doc.createdAt.toISOString(),
      qualityScores: doc.validationScores as Record<string, number>
    }, outputPath);
    
    // Update database with PDF metadata
    await prisma.strategyDocument.update({
      where: { id: doc.id },
      data: {
        pdfGeneratedAt: new Date(),
        pdfSizeBytes: result.sizeBytes
      }
    });
    
    // Send PDF file
    res.download(result.filePath, `${doc.researchJob.client.name}-strategy.pdf`);
    
  } catch (error) {
    console.error('[PDF Export] Error:', error);
    res.status(500).json({ error: 'PDF generation failed' });
  }
});

export default router;
```

## Future Enhancements

### Cover Page Template
```markdown
<div class="cover">

# Brand Strategy Document

## [Client Name]

**Prepared by**: [Your Company]  
**Date**: [Generation Date]  
**Version**: 1.0

</div>

<div class="page-break"></div>
```

### Table of Contents (Auto-generated)
```typescript
import { marked } from 'marked';

function generateTOC(markdown: string): string {
  const tokens = marked.lexer(markdown);
  const headers = tokens.filter(t => t.type === 'heading' && t.depth <= 2);
  
  return `
## Table of Contents

${headers.map((h, i) => {
  const indent = '  '.repeat(h.depth - 1);
  return `${indent}${i + 1}. ${h.text}`;
}).join('\n')}
`;
}
```

### Charts/Graphs
Use Chart.js to generate images, embed in markdown:
```markdown
![Engagement Analysis](data:image/png;base64,...)
```

## Testing

```typescript
// Test PDF generation
import { generateStrategyPDF } from './strategy-pdf-generator';

const mockContent = {
  businessUnderstanding: '# Business\n\nTest content...',
  targetAudience: '# Audience\n\nTest personas...',
  // ...
  clientName: 'Test Client',
  generatedDate: new Date().toISOString(),
  qualityScores: { business: 92, audience: 88 }
};

const result = await generateStrategyPDF(mockContent, './test-output.pdf');
console.log('PDF Generated:', result);
```

## Summary

✅ **All content is markdown** - clean, structured, version-controllable
✅ **PDF-ready formatting** - headers, tables, lists all supported
✅ **Professional styling** - custom CSS for branded output
✅ **Scalable** - easy to add sections or modify layout
✅ **Exportable** - one-click PDF generation via API
