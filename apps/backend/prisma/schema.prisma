generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id                     String              @id @default(uuid())
  name                   String
  businessOverview       String?             @map("business_overview")
  productsServices       String?             @map("products_services")
  uniqueValueProposition String?             @map("unique_value_proposition")
  visionMission          String?             @map("vision_mission")
  brandStory             String?             @map("brand_story")
  toneOfVoice            String?             @map("tone_of_voice")
  brandPersonality       String?             @map("brand_personality")
  keySellingPoints       String?             @map("key_selling_points")
  currentSocialPresence  String?             @map("current_social_presence")
  challenges             String?
  goalsKpis              String?             @map("goals_kpis")
  createdAt              DateTime            @default(now()) @map("created_at")
  updatedAt              DateTime            @updatedAt @map("updated_at")
  brainProfile           BrainProfile?
  brainProfileSuggestions BrainProfileSuggestion[]
  brandMentions          BrandMention[]
  buyerJourneyStages     BuyerJourneyStage[]
  clientAccounts         ClientAccount[]
  clientDocuments        ClientDocument[]
  clientProfiles         ClientProfile[]
  competitors            Competitor[]
  contentPillars         ContentPillar[]
  monitoringLogs         MonitoringLog[]
  personas               Persona[]
  platformStrategies     PlatformStrategy[]
  researchJobs           ResearchJob[]

  @@map("clients")
}

model Persona {
  id                  String  @id @default(uuid())
  clientId            String  @map("client_id")
  name                String
  role                String?
  ageRange            String? @map("age_range")
  occupationLifestyle String? @map("occupation_lifestyle")
  goals               String?
  painPoints          String? @map("pain_points")
  fears               String?
  motivators          String?
  blockers            String?
  preferredContent    String? @map("preferred_content")
  onlinePresence      String? @map("online_presence")
  client              Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("personas")
}

model ResearchJob {
  id                          String                       @id @default(uuid())
  clientId                    String                       @map("client_id")
  status                      ResearchJobStatus            @default(PENDING)
  inputData                   Json?                        @map("input_data")
  competitorsToFind           Int                          @default(10) @map("competitors_to_find")
  priorityCompetitors         Int                          @default(3) @map("priority_competitors")
  errorMessage                String?                      @map("error_message")
  startedAt                   DateTime?                    @map("started_at")
  completedAt                 DateTime?                    @map("completed_at")
  continuityEnabled           Boolean                      @default(false) @map("continuity_enabled")
  continuityErrorMessage      String?                      @map("continuity_error_message")
  continuityIntervalHours     Int                          @default(2) @map("continuity_interval_hours")
  continuityLastRunAt         DateTime?                    @map("continuity_last_run_at")
  continuityNextRunAt         DateTime?                    @map("continuity_next_run_at")
  continuityRunning           Boolean                      @default(false) @map("continuity_running")
  aiAnalyses                  AiAnalysis[]
  mediaAnalysisRuns           MediaAnalysisRun[]
  aiBusinessAnalyses          AiBusinessAnalysis[]
  aiQuestions                 AiQuestion[]
  brainCommands               BrainCommand[]
  brandIntelligenceRuns       BrandIntelligenceRun[]
  clientProfileSnapshots      ClientProfileSnapshot[]
  communityInsights           CommunityInsight[]
  competitorCandidateProfiles CompetitorCandidateProfile[]
  competitorEntities          CompetitorEntity[]
  competitorIdentities        CompetitorIdentity[]
  competitorOrchestrationRuns CompetitorOrchestrationRun[]
  competitorProfileSnapshots  CompetitorProfileSnapshot[]
  competitorSurfaces          CompetitorSurface[]
  ddgImageResults             DdgImageResult[]
  ddgNewsResults              DdgNewsResult[]
  ddgVideoResults             DdgVideoResult[]
  discoveredCompetitors       DiscoveredCompetitor[]
  evidenceRefs                EvidenceRef[]
  orchestrationPlans          OrchestrationPlan[]
  rawSearchResults            RawSearchResult[]
  events                      ResearchJobEvent[]
  client                      Client                       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  searchTrends                SearchTrend[]
  socialProfiles              SocialProfile[]
  socialTrends                SocialTrend[]
  contentCalendarRuns         ContentCalendarRun[]
  calendarChatSessions        CalendarChatSession[]
  chatSessions                ChatSession[]
  chatThreads                 ChatThread[]
  strategyDocChatSessions     StrategyDocChatSession[]
  clientIntakeAnswers         ClientIntakeAnswer[]
  screenshotAttachments       ScreenshotAttachment[]
  fileAttachments             FileAttachment[]
  chatMutations               ChatMutation[]
  userSuppliedContexts        UserSuppliedContext[]
  webSources                  WebSource[]
  webPageSnapshots            WebPageSnapshot[]
  webExtractionRecipes        WebExtractionRecipe[]
  webExtractionRuns           WebExtractionRun[]
  adaptiveSelectorMemories    AdaptiveSelectorMemory[]
  portalMemberships           PortalWorkspaceMembership[]

  @@map("research_jobs")
}

enum PortalUserRole {
  ADMIN
  CLIENT
}

enum PortalEmailTokenType {
  VERIFY_EMAIL
  PASSWORD_RESET
}

model PortalUser {
  id              String                     @id @default(uuid())
  email           String                     @unique
  passwordHash    String                     @map("password_hash")
  fullName        String?                    @map("full_name")
  companyName     String?                    @map("company_name")
  emailVerifiedAt DateTime?                  @map("email_verified_at")
  isAdmin         Boolean                    @default(false) @map("is_admin")
  createdAt       DateTime                   @default(now()) @map("created_at")
  updatedAt       DateTime                   @updatedAt @map("updated_at")
  memberships     PortalWorkspaceMembership[]
  sessions        PortalSession[]
  emailTokens     PortalEmailToken[]

  @@map("portal_users")
}

model PortalWorkspaceMembership {
  id            String         @id @default(uuid())
  userId        String         @map("user_id")
  researchJobId String         @map("research_job_id")
  role          PortalUserRole @default(CLIENT)
  createdAt     DateTime       @default(now()) @map("created_at")

  user        PortalUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  researchJob ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@unique([userId, researchJobId])
  @@index([researchJobId, role])
  @@map("portal_workspace_memberships")
}

model PortalSession {
  id         String     @id @default(uuid())
  userId     String     @map("user_id")
  tokenHash  String     @unique @map("token_hash")
  expiresAt  DateTime   @map("expires_at")
  revokedAt  DateTime?  @map("revoked_at")
  lastSeenAt DateTime?  @map("last_seen_at")
  userAgent  String?    @map("user_agent")
  ipAddress  String?    @map("ip_address")
  createdAt  DateTime   @default(now()) @map("created_at")

  user PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([expiresAt, revokedAt])
  @@map("portal_sessions")
}

model PortalEmailToken {
  id        String             @id @default(uuid())
  userId    String             @map("user_id")
  type      PortalEmailTokenType
  tokenHash String             @unique @map("token_hash")
  expiresAt DateTime           @map("expires_at")
  usedAt    DateTime?          @map("used_at")
  createdAt DateTime           @default(now()) @map("created_at")

  user PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type, createdAt(sort: Desc)])
  @@index([expiresAt, usedAt])
  @@map("portal_email_tokens")
}

model ResearchJobEvent {
  id            Int         @id @default(autoincrement())
  researchJobId String      @map("research_job_id")
  runId         String?     @map("run_id")
  source        String
  code          String
  level         String      @default("info")
  message       String
  platform      String?
  handle        String?
  entityType    String?     @map("entity_type")
  entityId      String?     @map("entity_id")
  metrics       Json?
  metadata      Json?
  createdAt     DateTime    @default(now()) @map("created_at")
  researchJob   ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId, createdAt])
  @@index([researchJobId, id])
  @@index([researchJobId, runId])
  @@index([researchJobId, level])
  @@map("research_job_events")
}

model RawSearchResult {
  id            String      @id @default(uuid())
  researchJobId String      @map("research_job_id")
  query         String
  source        String      @default("duckduckgo")
  title         String
  href          String
  body          String
  isProcessed   Boolean     @default(false) @map("is_processed")
  extractedData Json?       @map("extracted_data")
  firstSeenAt   DateTime    @default(now()) @map("first_seen_at")
  lastSeenAt    DateTime    @default(now()) @map("last_seen_at")
  seenCount     Int         @default(1) @map("seen_count")
  isActive      Boolean     @default(true) @map("is_active")
  archivedAt    DateTime?   @map("archived_at")
  archivedBy    String?     @map("archived_by")
  manuallyModified Boolean  @default(false) @map("manually_modified")
  lastModifiedAt DateTime?  @map("last_modified_at")
  lastModifiedBy String?    @map("last_modified_by")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  researchJob   ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@unique([researchJobId, href])
  @@index([researchJobId])
  @@index([isProcessed])
  @@map("raw_search_results")
}

model WebSource {
  id               String                   @id @default(uuid())
  researchJobId    String                   @map("research_job_id")
  url              String
  domain           String
  sourceType       WebSourceType            @default(OTHER) @map("source_type")
  discoveredBy     WebSourceDiscoveryMethod @default(USER) @map("discovered_by")
  isActive         Boolean                  @default(true) @map("is_active")
  archivedAt       DateTime?                @map("archived_at")
  archivedBy       String?                  @map("archived_by")
  manuallyModified Boolean                  @default(false) @map("manually_modified")
  lastModifiedAt   DateTime?                @map("last_modified_at")
  lastModifiedBy   String?                  @map("last_modified_by")
  createdAt        DateTime                 @default(now()) @map("created_at")
  updatedAt        DateTime                 @updatedAt @map("updated_at")
  researchJob      ResearchJob              @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  snapshots        WebPageSnapshot[]

  @@index([researchJobId, domain])
  @@index([isActive])
  @@unique([researchJobId, url])
  @@map("web_sources")
}

model WebPageSnapshot {
  id               String         @id @default(uuid())
  researchJobId    String         @map("research_job_id")
  webSourceId      String         @map("web_source_id")
  fetchedAt        DateTime       @default(now()) @map("fetched_at")
  fetcherUsed      WebFetcherMode @default(AUTO) @map("fetcher_used")
  finalUrl         String?        @map("final_url")
  statusCode       Int?           @map("status_code")
  contentHash      String?        @map("content_hash")
  htmlPath         String?        @map("html_path")
  textPath         String?        @map("text_path")
  cleanText        String?        @map("clean_text")
  metadata         Json?
  isActive         Boolean        @default(true) @map("is_active")
  archivedAt       DateTime?      @map("archived_at")
  archivedBy       String?        @map("archived_by")
  manuallyModified Boolean        @default(false) @map("manually_modified")
  lastModifiedAt   DateTime?      @map("last_modified_at")
  lastModifiedBy   String?        @map("last_modified_by")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  webSource        WebSource      @relation(fields: [webSourceId], references: [id], onDelete: Cascade)
  researchJob      ResearchJob    @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  extractionRuns   WebExtractionRun[]

  @@index([researchJobId, fetchedAt])
  @@index([webSourceId, fetchedAt])
  @@index([contentHash])
  @@index([isActive])
  @@map("web_page_snapshots")
}

model WebExtractionRecipe {
  id               String      @id @default(uuid())
  researchJobId    String      @map("research_job_id")
  name             String
  targetDomain     String?     @map("target_domain")
  schema           Json
  createdBy        String?     @map("created_by")
  isActive         Boolean     @default(true) @map("is_active")
  archivedAt       DateTime?   @map("archived_at")
  archivedBy       String?     @map("archived_by")
  manuallyModified Boolean     @default(false) @map("manually_modified")
  lastModifiedAt   DateTime?   @map("last_modified_at")
  lastModifiedBy   String?     @map("last_modified_by")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  researchJob      ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  runs             WebExtractionRun[]

  @@index([researchJobId, name])
  @@index([isActive])
  @@map("web_extraction_recipes")
}

model WebExtractionRun {
  id               String              @id @default(uuid())
  researchJobId    String              @map("research_job_id")
  recipeId         String              @map("recipe_id")
  snapshotId       String              @map("snapshot_id")
  extracted        Json
  confidence       Float?              @default(0)
  warnings         Json?
  isActive         Boolean             @default(true) @map("is_active")
  archivedAt       DateTime?           @map("archived_at")
  archivedBy       String?             @map("archived_by")
  manuallyModified Boolean             @default(false) @map("manually_modified")
  lastModifiedAt   DateTime?           @map("last_modified_at")
  lastModifiedBy   String?             @map("last_modified_by")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  researchJob      ResearchJob         @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  recipe           WebExtractionRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  snapshot         WebPageSnapshot     @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([researchJobId, createdAt])
  @@index([recipeId, createdAt])
  @@index([snapshotId, createdAt])
  @@index([isActive])
  @@map("web_extraction_runs")
}

model AdaptiveSelectorMemory {
  id            String      @id @default(uuid())
  researchJobId String      @map("research_job_id")
  namespace     String
  key           String
  elementJson   Json        @map("element_json")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  researchJob   ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@unique([researchJobId, namespace, key])
  @@index([researchJobId, namespace])
  @@map("adaptive_selector_memory")
}

model DdgNewsResult {
  id            String      @id @default(uuid())
  researchJobId String      @map("research_job_id")
  query         String
  title         String
  body          String?
  url           String
  source        String?
  imageUrl      String?     @map("image_url")
  publishedAt   String?     @map("published_at")
  isActive      Boolean     @default(true) @map("is_active")
  archivedAt    DateTime?   @map("archived_at")
  archivedBy    String?     @map("archived_by")
  manuallyModified Boolean  @default(false) @map("manually_modified")
  lastModifiedAt DateTime?  @map("last_modified_at")
  lastModifiedBy String?    @map("last_modified_by")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  researchJob   ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId])
  @@map("ddg_news_results")
}

model DdgVideoResult {
  id            String       @id @default(uuid())
  researchJobId String       @map("research_job_id")
  query         String
  title         String
  description   String?
  url           String
  embedUrl      String?      @map("embed_url")
  duration      String?
  publisher     String?
  uploader      String?
  viewCount     Int?         @map("view_count")
  thumbnailUrl  String?      @map("thumbnail_url")
  publishedAt   String?      @map("published_at")
  isActive      Boolean      @default(true) @map("is_active")
  archivedAt    DateTime?    @map("archived_at")
  archivedBy    String?      @map("archived_by")
  manuallyModified Boolean   @default(false) @map("manually_modified")
  lastModifiedAt DateTime?   @map("last_modified_at")
  lastModifiedBy String?     @map("last_modified_by")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  isDownloaded  Boolean      @default(false) @map("is_downloaded")
  researchJob   ResearchJob  @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  mediaAssets   MediaAsset[]

  @@index([researchJobId])
  @@index([isDownloaded])
  @@map("ddg_video_results")
}

model DdgImageResult {
  id            String       @id @default(uuid())
  researchJobId String       @map("research_job_id")
  query         String
  title         String
  imageUrl      String       @map("image_url")
  thumbnailUrl  String?      @map("thumbnail_url")
  sourceUrl     String       @map("source_url")
  width         Int?
  height        Int?
  isActive      Boolean      @default(true) @map("is_active")
  archivedAt    DateTime?    @map("archived_at")
  archivedBy    String?      @map("archived_by")
  manuallyModified Boolean   @default(false) @map("manually_modified")
  lastModifiedAt DateTime?   @map("last_modified_at")
  lastModifiedBy String?     @map("last_modified_by")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  isDownloaded  Boolean      @default(false) @map("is_downloaded")
  researchJob   ResearchJob  @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  mediaAssets   MediaAsset[]

  @@index([researchJobId])
  @@index([isDownloaded])
  @@map("ddg_image_results")
}

model SocialProfile {
  id            String       @id @default(uuid())
  researchJobId String       @map("research_job_id")
  platform      String
  handle        String
  url           String?
  followers     Int?
  following     Int?
  postsCount    Int?         @map("posts_count")
  bio           String?
  website       String?
  isVerified    Boolean      @default(false) @map("is_verified")
  lastScrapedAt DateTime?    @map("last_scraped_at")
  lastPostId    String?      @map("last_post_id")
  cursor        String?
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  posts         SocialPost[]
  researchJob   ResearchJob  @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@unique([researchJobId, platform, handle])
  @@map("social_profiles")
}

model SocialPost {
  id              String        @id @default(uuid())
  socialProfileId String        @map("social_profile_id")
  externalId      String        @map("external_id")
  url             String?
  type            String?
  caption         String?
  hashtags        Json?
  mentions        Json?
  thumbnailUrl    String?       @map("thumbnail_url")
  likesCount      Int?          @map("likes_count")
  commentsCount   Int?          @map("comments_count")
  sharesCount     Int?          @map("shares_count")
  viewsCount      Int?          @map("views_count")
  playsCount      Int?          @map("plays_count")
  duration        Float?
  metadata        Json?
  postedAt        DateTime?     @map("posted_at")
  scrapedAt       DateTime      @default(now()) @map("scraped_at")
  mediaAssets     MediaAsset[]
  socialProfile   SocialProfile @relation(fields: [socialProfileId], references: [id], onDelete: Cascade)
  trends          SocialTrend[]

  @@unique([socialProfileId, externalId])
  @@map("social_posts")
}

model SocialTrend {
  id            String       @id @default(uuid())
  researchJobId String?      @map("research_job_id")
  socialPostId  String?      @map("social_post_id")
  name          String
  platform      String?
  type          String?
  volume        Int?
  growthRate    Float?       @map("growth_rate")
  sentiment     String?
  firstSeenAt   DateTime     @default(now()) @map("first_seen_at")
  lastSeenAt    DateTime     @default(now()) @map("last_seen_at")
  researchJob   ResearchJob? @relation(fields: [researchJobId], references: [id])
  socialPost    SocialPost?  @relation(fields: [socialPostId], references: [id])

  @@index([name])
  @@index([researchJobId])
  @@map("social_trends")
}

model SearchTrend {
  id               String      @id @default(uuid())
  researchJobId    String      @map("research_job_id")
  keyword          String
  region           String      @default("US")
  timeframe        String      @default("today 12-m")
  interestOverTime Json?       @map("interest_over_time")
  relatedQueries   Json?       @map("related_queries")
  relatedTopics    Json?       @map("related_topics")
  isActive         Boolean     @default(true) @map("is_active")
  archivedAt       DateTime?   @map("archived_at")
  archivedBy       String?     @map("archived_by")
  manuallyModified Boolean     @default(false) @map("manually_modified")
  lastModifiedAt   DateTime?   @map("last_modified_at")
  lastModifiedBy   String?     @map("last_modified_by")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  researchJob      ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId])
  @@map("search_trends")
}

model CommunityInsight {
  id                     String                @id @default(uuid())
  researchJobId          String                @map("research_job_id")
  source                 String
  url                    String
  content                String
  sentiment              String?
  painPoints             Json?
  desires                Json?
  marketingHooks         Json?
  metric                 String?
  metricValue            Int?                  @map("metric_value")
  createdAt              DateTime              @default(now()) @map("created_at")
  brandIntelligenceRunId String?               @map("brand_intelligence_run_id")
  sourceQuery            String?               @map("source_query")
  evidence               Json?
  isActive               Boolean               @default(true) @map("is_active")
  archivedAt             DateTime?             @map("archived_at")
  archivedBy             String?               @map("archived_by")
  manuallyModified       Boolean               @default(false) @map("manually_modified")
  lastModifiedAt         DateTime?             @map("last_modified_at")
  lastModifiedBy         String?               @map("last_modified_by")
  updatedAt              DateTime              @updatedAt @map("updated_at")
  brandIntelligenceRun   BrandIntelligenceRun? @relation(fields: [brandIntelligenceRunId], references: [id])
  researchJob            ResearchJob           @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId])
  @@index([brandIntelligenceRunId])
  @@map("community_insights")
}

model AiBusinessAnalysis {
  id                   String      @id @default(uuid())
  researchJobId        String      @map("research_job_id")
  valueProposition     String?     @map("value_proposition")
  targetAudience       String?     @map("target_audience")
  contentPillars       Json?       @map("content_pillars")
  brandVoice           String?     @map("brand_voice")
  brandPersonality     String?     @map("brand_personality")
  competitorAnalysis   String?     @map("competitor_analysis")
  nichePosition        String?     @map("niche_position")
  uniqueStrengths      Json?       @map("unique_strengths")
  contentOpportunities Json?       @map("content_opportunities")
  rawAiResponse        Json?       @map("raw_ai_response")
  promptUsed           String?     @map("prompt_used")
  modelUsed            String?     @map("model_used")
  tokensUsed           Int?        @map("tokens_used")
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")
  researchJob          ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId])
  @@map("ai_business_analyses")
}

model AiQuestion {
  id            String         @id @default(uuid())
  researchJobId String         @map("research_job_id")
  questionType  AiQuestionType @map("question_type")
  question      String
  answer        String?
  answerJson    Json?          @map("answer_json")
  contextUsed   String?        @map("context_used")
  promptUsed    String?        @map("prompt_used")
  modelUsed     String?        @map("model_used")
  tokensUsed    Int?           @map("tokens_used")
  durationMs    Int?           @map("duration_ms")
  isAnswered    Boolean        @default(false) @map("is_answered")
  isActive      Boolean        @default(true) @map("is_active")
  archivedAt    DateTime?      @map("archived_at")
  archivedBy    String?        @map("archived_by")
  manuallyModified Boolean     @default(false) @map("manually_modified")
  lastModifiedAt DateTime?     @map("last_modified_at")
  lastModifiedBy String?       @map("last_modified_by")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  answeredAt    DateTime?      @map("answered_at")
  researchJob   ResearchJob    @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@unique([researchJobId, questionType])
  @@index([researchJobId])
  @@index([questionType])
  @@map("ai_questions")
}

model ClientDocument {
  id            String       @id @default(uuid())
  clientId      String       @map("client_id")
  docType       DocumentType @map("doc_type")
  fileName      String       @map("file_name")
  filePath      String       @map("file_path")
  mimeType      String?      @map("mime_type")
  fileSizeBytes Int?         @map("file_size_bytes")
  extractedText String?      @map("extracted_text")
  isProcessed   Boolean      @default(false) @map("is_processed")
  uploadedAt    DateTime     @default(now()) @map("uploaded_at")
  aiAnalyses    AiAnalysis[]
  client        Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_documents")
}

model BrainProfile {
  id             String      @id @default(uuid())
  clientId       String      @unique @map("client_id")
  businessType   String?     @map("business_type")
  offerModel     String?     @map("offer_model")
  primaryGoal    String?     @map("primary_goal")
  secondaryGoals Json?       @map("secondary_goals")
  targetMarket   String?     @map("target_market")
  geoScope       String?     @map("geo_scope")
  websiteDomain  String?     @map("website_domain")
  channels       Json?
  constraints    Json?
  meta           Json?
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  goals          BrainGoal[]
  client         Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("brain_profiles")
}

model BrainGoal {
  id             String       @id @default(uuid())
  brainProfileId String       @map("brain_profile_id")
  goalType       String       @map("goal_type")
  priority       Int          @default(1)
  targetMetric   String?      @map("target_metric")
  targetValue    String?      @map("target_value")
  targetDate     DateTime?    @map("target_date")
  notes          String?
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  brainProfile   BrainProfile @relation(fields: [brainProfileId], references: [id], onDelete: Cascade)

  @@index([brainProfileId, priority])
  @@map("brain_goals")
}

model BrainProfileSuggestion {
  id            String                       @id @default(uuid())
  clientId      String                       @map("client_id")
  field         String
  proposedValue Json                         @map("proposed_value")
  approvedValue Json?                        @map("approved_value")
  reason        String?
  source        String?
  status        BrainProfileSuggestionStatus @default(PENDING)
  createdAt     DateTime                     @default(now()) @map("created_at")
  resolvedAt    DateTime?                    @map("resolved_at")
  resolvedBy    String?                      @map("resolved_by")
  client        Client                       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, status, createdAt(sort: Desc)])
  @@index([clientId, field, status])
  @@map("brain_profile_suggestions")
}

model BrainCommand {
  id            String             @id @default(uuid())
  researchJobId String             @map("research_job_id")
  section       String
  commandType   BrainCommandType   @map("command_type")
  instruction   String
  proposedPatch Json?              @map("proposed_patch")
  appliedPatch  Json?              @map("applied_patch")
  status        BrainCommandStatus @default(PENDING)
  replyText     String?            @map("reply_text")
  error         String?
  createdBy     String?            @map("created_by")
  createdAt     DateTime           @default(now()) @map("created_at")
  appliedAt     DateTime?          @map("applied_at")
  researchJob   ResearchJob        @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId, status, createdAt(sort: Desc)])
  @@map("brain_commands")
}

model OrchestrationPlan {
  id            String                  @id @default(uuid())
  researchJobId String                  @map("research_job_id")
  runId         String?                 @map("run_id")
  steps         Json
  status        OrchestrationStepStatus @default(PENDING)
  diagnostics   Json?
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")
  researchJob   ResearchJob             @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId, createdAt(sort: Desc)])
  @@map("orchestration_plans")
}

model DiscoveredCompetitor {
  id                 String                       @id @default(uuid())
  researchJobId      String                       @map("research_job_id")
  competitorId       String?                      @map("competitor_id")
  handle             String
  platform           String
  profileUrl         String?                      @map("profile_url")
  discoveryReason    String?                      @map("discovery_reason")
  relevanceScore     Float?                       @map("relevance_score")
  status             DiscoveredCompetitorStatus   @default(SUGGESTED)
  discoveredAt       DateTime                     @default(now()) @map("discovered_at")
  scrapedAt          DateTime?                    @map("scraped_at")
  postsScraped       Int                          @default(0) @map("posts_scraped")
  lastCheckedAt      DateTime?                    @map("last_checked_at")
  latestPostId       String?                      @map("latest_post_id")
  evidence           Json?
  orchestrationRunId String?                      @map("orchestration_run_id")
  scoreBreakdown     Json?                        @map("score_breakdown")
  selectionReason    String?                      @map("selection_reason")
  selectionState     CompetitorSelectionState     @default(SHORTLISTED) @map("selection_state")
  competitorType     CompetitorType?              @map("competitor_type")
  typeConfidence     Float?                       @map("type_confidence")
  entityFlags        Json?                        @map("entity_flags")
  candidateProfileId String?                      @map("candidate_profile_id")
  availabilityStatus CompetitorAvailabilityStatus @default(UNVERIFIED) @map("availability_status")
  availabilityReason String?                      @map("availability_reason")
  displayOrder       Int?                         @map("display_order")
  isActive           Boolean                      @default(true) @map("is_active")
  archivedAt         DateTime?                    @map("archived_at")
  archivedBy         String?                      @map("archived_by")
  manuallyModified   Boolean                      @default(false) @map("manually_modified")
  lastModifiedBy     String?                      @map("last_modified_by")
  lastModifiedAt     DateTime?                    @map("last_modified_at")
  updatedAt          DateTime                     @updatedAt @map("updated_at")
  candidateProfile   CompetitorCandidateProfile?  @relation(fields: [candidateProfileId], references: [id])
  competitor         Competitor?                  @relation(fields: [competitorId], references: [id])
  orchestrationRun   CompetitorOrchestrationRun?  @relation(fields: [orchestrationRunId], references: [id])
  researchJob        ResearchJob                  @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@unique([researchJobId, platform, handle])
  @@index([researchJobId, selectionState, relevanceScore(sort: Desc)])
  @@index([orchestrationRunId])
  @@index([candidateProfileId])
  @@index([researchJobId, competitorType, selectionState], map: "discovered_competitors_type_state_idx")
  @@index([researchJobId, selectionState, relevanceScore(sort: Desc)], map: "discovered_competitors_research_job_id_selection_state_relevanc")
  @@map("discovered_competitors")
}

model CompetitorOrchestrationRun {
  id                    String                       @id @default(uuid())
  researchJobId         String                       @map("research_job_id")
  platforms             Json
  targetCount           Int                          @default(10) @map("target_count")
  mode                  String                       @default("append")
  status                String                       @default("RUNNING")
  summary               Json?
  startedAt             DateTime                     @default(now()) @map("started_at")
  completedAt           DateTime?                    @map("completed_at")
  createdAt             DateTime                     @default(now()) @map("created_at")
  strategyVersion       String                       @default("v2") @map("strategy_version")
  configSnapshot        Json?                        @map("config_snapshot")
  diagnostics           Json?
  phase                 String?
  errorCode             String?                      @map("error_code")
  degradedConnectors    Json?                        @map("degraded_connectors")
  qualityScore          Float?                       @map("quality_score")
  candidateProfiles     CompetitorCandidateProfile[]
  researchJob           ResearchJob                  @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  discoveredCompetitors DiscoveredCompetitor[]

  @@index([researchJobId, createdAt(sort: Desc)])
  @@map("competitor_orchestration_runs")
}

model BrandIntelligenceRun {
  id                String             @id @default(uuid())
  researchJobId     String             @map("research_job_id")
  status            String             @default("RUNNING")
  mode              String             @default("append")
  modules           Json
  moduleOrder       Json               @map("module_order")
  moduleInputs      Json?              @map("module_inputs")
  runReason         String?            @map("run_reason")
  diagnostics       Json?
  summary           Json?
  startedAt         DateTime           @default(now()) @map("started_at")
  completedAt       DateTime?          @map("completed_at")
  createdAt         DateTime           @default(now()) @map("created_at")
  researchJob       ResearchJob        @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  brandMentions     BrandMention[]
  communityInsights CommunityInsight[]

  @@index([researchJobId, createdAt(sort: Desc)])
  @@map("brand_intelligence_runs")
}

model CompetitorIdentity {
  id                String                       @id @default(uuid())
  researchJobId     String                       @map("research_job_id")
  canonicalName     String                       @map("canonical_name")
  websiteDomain     String?                      @map("website_domain")
  businessType      String?                      @map("business_type")
  audienceSummary   String?                      @map("audience_summary")
  createdAt         DateTime                     @default(now()) @map("created_at")
  updatedAt         DateTime                     @updatedAt @map("updated_at")
  candidateProfiles CompetitorCandidateProfile[]
  researchJob       ResearchJob                  @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId, canonicalName])
  @@map("competitor_identities")
}

model CompetitorCandidateProfile {
  id                    String                        @id @default(uuid())
  researchJobId         String                        @map("research_job_id")
  orchestrationRunId    String                        @map("orchestration_run_id")
  identityId            String?                       @map("identity_id")
  platform              String
  handle                String
  normalizedHandle      String                        @map("normalized_handle")
  profileUrl            String?                       @map("profile_url")
  source                String
  inputType             String?                       @map("input_type")
  scrapeEligible        Boolean                       @default(false) @map("scrape_eligible")
  blockerReasonCode     String?                       @map("blocker_reason_code")
  availabilityStatus    CompetitorAvailabilityStatus  @default(UNVERIFIED) @map("availability_status")
  availabilityReason    String?                       @map("availability_reason")
  resolverConfidence    Float?                        @map("resolver_confidence")
  state                 CompetitorCandidateState      @default(DISCOVERED)
  stateReason           String?                       @map("state_reason")
  competitorType        CompetitorType?               @map("competitor_type")
  typeConfidence        Float?                        @map("type_confidence")
  entityFlags           Json?                         @map("entity_flags")
  relevanceScore        Float?                        @map("relevance_score")
  scoreBreakdown        Json?                         @map("score_breakdown")
  evidence              Json?
  createdAt             DateTime                      @default(now()) @map("created_at")
  updatedAt             DateTime                      @updatedAt @map("updated_at")
  lastVerifiedAt        DateTime?                     @map("last_verified_at")
  verificationAttempts  Int                           @default(0) @map("verification_attempts")
  verificationSource    String?                       @map("verification_source")
  displayOrder          Int?                          @map("display_order")
  evidenceRows          CompetitorCandidateEvidence[]
  identity              CompetitorIdentity?           @relation(fields: [identityId], references: [id])
  orchestrationRun      CompetitorOrchestrationRun    @relation(fields: [orchestrationRunId], references: [id], onDelete: Cascade)
  researchJob           ResearchJob                   @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  discoveredCompetitors DiscoveredCompetitor[]

  @@unique([researchJobId, platform, normalizedHandle])
  @@index([researchJobId, state, relevanceScore(sort: Desc)])
  @@index([researchJobId, competitorType, state], map: "competitor_candidate_type_state_idx")
  @@index([researchJobId, availabilityStatus])
  @@index([researchJobId, scrapeEligible, state, availabilityStatus])
  @@index([orchestrationRunId, platform])
  @@index([identityId])
  @@map("competitor_candidate_profiles")
}

model CompetitorCandidateEvidence {
  id                 String                     @id @default(uuid())
  candidateProfileId String                     @map("candidate_profile_id")
  sourceType         String                     @map("source_type")
  query              String?
  title              String?
  url                String?
  snippet            String?
  signalScore        Float?                     @map("signal_score")
  createdAt          DateTime                   @default(now()) @map("created_at")
  candidateProfile   CompetitorCandidateProfile @relation(fields: [candidateProfileId], references: [id], onDelete: Cascade)

  @@index([candidateProfileId])
  @@map("competitor_candidate_evidence")
}

model CompetitorEntity {
  id               String                    @id @default(uuid())
  researchJobId    String                    @map("research_job_id")
  entityType       CompetitorEntityType      @default(BUSINESS) @map("entity_type")
  name             String
  primaryDomain    String?                   @map("primary_domain")
  canonicalUrl     String?                   @map("canonical_url")
  relationshipType CompetitorRelationshipType? @map("relationship_type")
  confidence       Float?
  tags             Json?
  fingerprintJson  Json?                     @map("fingerprint_json")
  createdBy        String                    @default("SYSTEM") @map("created_by")
  status           CompetitorEntityStatus    @default(ACTIVE)
  createdAt        DateTime                  @default(now()) @map("created_at")
  updatedAt        DateTime                  @updatedAt @map("updated_at")
  researchJob      ResearchJob               @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  surfaces         CompetitorSurface[]
  evidenceRefs     EvidenceRef[]

  @@index([researchJobId, relationshipType, confidence(sort: Desc)], map: "competitor_entities_relationship_idx")
  @@index([researchJobId, primaryDomain], map: "competitor_entities_domain_idx")
  @@unique([researchJobId, entityType, primaryDomain], map: "comp_entities_rj_et_pd_key")
  @@map("competitor_entities")
}

model CompetitorSurface {
  id                String                     @id @default(uuid())
  researchJobId     String                     @map("research_job_id")
  entityId          String                     @map("entity_id")
  surfaceType       CompetitorSurfaceType      @map("surface_type")
  value             String
  normalizedValue   String                     @map("normalized_value")
  url               String?
  scrapeCapability  CompetitorScrapeCapability @default(NOT_SCRAPABLE_YET) @map("scrape_capability")
  blockerReasonCode String?                    @map("blocker_reason_code")
  lastScrapedAt     DateTime?                  @map("last_scraped_at")
  metadata          Json?
  createdAt         DateTime                   @default(now()) @map("created_at")
  updatedAt         DateTime                   @updatedAt @map("updated_at")
  entity            CompetitorEntity           @relation(fields: [entityId], references: [id], onDelete: Cascade)
  researchJob       ResearchJob                @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  evidenceRefs      EvidenceRef[]

  @@unique([researchJobId, surfaceType, normalizedValue], map: "comp_surfaces_rj_st_nv_key")
  @@index([entityId, surfaceType], map: "competitor_surfaces_entity_surface_idx")
  @@index([researchJobId, surfaceType, scrapeCapability], map: "competitor_surfaces_research_surface_capability_idx")
  @@map("competitor_surfaces")
}

model EvidenceRef {
  id            String          @id @default(uuid())
  researchJobId String          @map("research_job_id")
  entityId      String?         @map("entity_id")
  surfaceId     String?         @map("surface_id")
  kind          EvidenceRefKind
  refId         String?         @map("ref_id")
  url           String?
  label         String?
  metadata      Json?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  entity        CompetitorEntity? @relation(fields: [entityId], references: [id], onDelete: Cascade)
  surface       CompetitorSurface? @relation(fields: [surfaceId], references: [id], onDelete: Cascade)
  researchJob   ResearchJob     @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId, kind, createdAt(sort: Desc)], map: "evidence_refs_job_kind_created_idx")
  @@index([entityId, kind], map: "evidence_refs_entity_kind_idx")
  @@index([surfaceId], map: "evidence_refs_surface_idx")
  @@map("evidence_refs")
}

model ClientAccount {
  id              String       @id @default(uuid())
  clientId        String       @map("client_id")
  platform        String
  handle          String
  profileUrl      String?      @map("profile_url")
  followerCount   Int?         @map("follower_count")
  followingCount  Int?         @map("following_count")
  bio             String?
  profileImageUrl String?      @map("profile_image_url")
  lastScrapedAt   DateTime?    @map("last_scraped_at")
  isActive        Boolean      @default(true) @map("is_active")
  archivedAt      DateTime?    @map("archived_at")
  archivedBy      String?      @map("archived_by")
  manuallyModified Boolean     @default(false) @map("manually_modified")
  lastModifiedAt  DateTime?    @map("last_modified_at")
  lastModifiedBy  String?      @map("last_modified_by")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  client          Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientPosts     ClientPost[]

  @@unique([clientId, platform, handle])
  @@map("client_accounts")
}

model ClientPost {
  id              String        @id @default(uuid())
  clientAccountId String        @map("client_account_id")
  externalPostId  String        @unique @map("external_post_id")
  postUrl         String?       @map("post_url")
  caption         String?
  format          String?
  likes           Int?
  comments        Int?
  saves           Int?
  shares          Int?
  engagementRate  Float?        @map("engagement_rate")
  rawApiResponse  Json?         @map("raw_api_response")
  postedAt        DateTime?     @map("posted_at")
  scrapedAt       DateTime      @default(now()) @map("scraped_at")
  aiAnalyses      AiAnalysis[]
  clientAccount   ClientAccount @relation(fields: [clientAccountId], references: [id], onDelete: Cascade)
  mediaAssets     MediaAsset[]

  @@map("client_posts")
}

model Competitor {
  id                     String                 @id @default(uuid())
  clientId               String                 @map("client_id")
  name                   String?
  handle                 String
  platform               String
  isPriority             Boolean                @default(false) @map("is_priority")
  followerCount          Int?                   @map("follower_count")
  postingFrequency       String?                @map("posting_frequency")
  mostUsedFormats        Json?                  @map("most_used_formats")
  contentPillarsObserved String?                @map("content_pillars_observed")
  engagementLevel        String?                @map("engagement_level")
  lastScrapedAt          DateTime?              @map("last_scraped_at")
  competitorProfiles     CompetitorProfile[]
  client                 Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  discoveredCompetitors  DiscoveredCompetitor[]
  rawPosts               RawPost[]

  @@unique([clientId, platform, handle])
  @@map("competitors")
}

model RawPost {
  id             String        @id @default(uuid())
  competitorId   String        @map("competitor_id")
  externalPostId String        @unique @map("external_post_id")
  platform       String
  postUrl        String?       @map("post_url")
  rawApiResponse Json?         @map("raw_api_response")
  scrapeSource   String?       @map("scrape_source")
  status         RawPostStatus @default(PENDING)
  scrapedAt      DateTime      @default(now()) @map("scraped_at")
  cleanedPost    CleanedPost?
  competitor     Competitor    @relation(fields: [competitorId], references: [id], onDelete: Cascade)

  @@map("raw_posts")
}

model CleanedPost {
  id             String          @id @default(uuid())
  rawPostId      String          @unique @map("raw_post_id")
  competitorId   String          @map("competitor_id")
  externalPostId String          @unique @map("external_post_id")
  postUrl        String?         @map("post_url")
  caption        String?
  format         String?
  likes          Int?
  comments       Int?
  saves          Int?
  shares         Int?
  engagementRate Float?          @map("engagement_rate")
  postedAt       DateTime?       @map("posted_at")
  cleanedAt      DateTime        @default(now()) @map("cleaned_at")
  aiAnalyses     AiAnalysis[]
  rawPost        RawPost         @relation(fields: [rawPostId], references: [id], onDelete: Cascade)
  mediaAssets    MediaAsset[]
  pillarExamples PillarExample[]

  @@map("cleaned_posts")
}

model MediaAsset {
  id                       String                  @id @default(uuid())
  clientPostId             String?                 @map("client_post_id")
  cleanedPostId            String?                 @map("cleaned_post_id")
  socialPostId             String?                 @map("social_post_id")
  clientPostSnapshotId     String?                 @map("client_post_snapshot_id")
  competitorPostSnapshotId String?                 @map("competitor_post_snapshot_id")
  sourceType               MediaSourceType?        @map("source_type")
  sourceId                 String?                 @map("source_id")
  externalMediaId          String?                 @map("external_media_id")
  mediaType                MediaType               @map("media_type")
  originalUrl              String?                 @map("original_url")
  blobStoragePath          String?                 @map("blob_storage_path")
  fileSizeBytes            Int?                    @map("file_size_bytes")
  durationSeconds          Int?                    @map("duration_seconds")
  width                    Int?
  height                   Int?
  thumbnailPath            String?                 @map("thumbnail_path")
  isDownloaded             Boolean                 @default(false) @map("is_downloaded")
  downloadedAt             DateTime?               @map("downloaded_at")
  downloadError            String?                 @map("download_error")
  isActive                 Boolean                 @default(true) @map("is_active")
  archivedAt               DateTime?               @map("archived_at")
  archivedBy               String?                 @map("archived_by")
  manuallyModified         Boolean                 @default(false) @map("manually_modified")
  lastModifiedAt           DateTime?               @map("last_modified_at")
  lastModifiedBy           String?                 @map("last_modified_by")
  updatedAt                DateTime                @updatedAt @map("updated_at")
  ddgVideoResultId         String?                 @map("ddg_video_result_id")
  ddgImageResultId         String?                 @map("ddg_image_result_id")
  aiAnalyses               AiAnalysis[]
  cleanedPost              CleanedPost?            @relation(fields: [cleanedPostId], references: [id], onDelete: Cascade)
  clientPost               ClientPost?             @relation(fields: [clientPostId], references: [id], onDelete: Cascade)
  clientPostSnapshot       ClientPostSnapshot?     @relation(fields: [clientPostSnapshotId], references: [id], onDelete: Cascade)
  competitorPostSnapshot   CompetitorPostSnapshot? @relation(fields: [competitorPostSnapshotId], references: [id], onDelete: Cascade)
  ddgImageResult           DdgImageResult?         @relation(fields: [ddgImageResultId], references: [id])
  ddgVideoResult           DdgVideoResult?         @relation(fields: [ddgVideoResultId], references: [id])
  socialPost               SocialPost?             @relation(fields: [socialPostId], references: [id], onDelete: Cascade)

  @@index([sourceType, sourceId])
  @@index([clientPostSnapshotId])
  @@index([competitorPostSnapshotId])
  @@map("media_assets")
}

model ClientProfile {
  id              String                  @id @default(uuid())
  clientId        String                  @map("client_id")
  platform        String
  handle          String
  profileUrl      String?                 @map("profile_url")
  followerCount   Int?                    @map("follower_count")
  followingCount  Int?                    @map("following_count")
  bio             String?
  profileImageUrl String?                 @map("profile_image_url")
  isVerified      Boolean                 @default(false) @map("is_verified")
  isPrivate       Boolean                 @default(false) @map("is_private")
  lastScrapedAt   DateTime?               @map("last_scraped_at")
  createdAt       DateTime                @default(now()) @map("created_at")
  updatedAt       DateTime                @updatedAt @map("updated_at")
  snapshots       ClientProfileSnapshot[]
  client          Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, platform, handle])
  @@map("client_profiles")
}

model ClientProfileSnapshot {
  id                          String               @id @default(uuid())
  clientProfileId             String               @map("client_profile_id")
  researchJobId               String?              @map("research_job_id")
  followerCount               Int?                 @map("follower_count")
  followingCount              Int?                 @map("following_count")
  bio                         String?
  profileImageUrl             String?              @map("profile_image_url")
  postsCount                  Int?                 @map("posts_count")
  isVerified                  Boolean              @default(false) @map("is_verified")
  isPrivate                   Boolean              @default(false) @map("is_private")
  readinessScore              Float?               @map("readiness_score")
  readinessStatus             String?              @map("readiness_status")
  readinessReasons            Json?                @map("readiness_reasons")
  lastReadinessAt             DateTime?            @map("last_readiness_at")
  lastMediaDownloadQueuedAt   DateTime?            @map("last_media_download_queued_at")
  runId                       String?              @map("run_id")
  orchestrationState          Json?                @map("orchestration_state")
  scrapedAt                   DateTime             @default(now()) @map("scraped_at")
  createdAt                   DateTime             @default(now()) @map("created_at")
  updatedAt                   DateTime             @updatedAt @map("updated_at")
  posts                       ClientPostSnapshot[]
  clientProfile               ClientProfile        @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)
  researchJob                 ResearchJob?         @relation(fields: [researchJobId], references: [id])

  @@index([researchJobId])
  @@index([researchJobId, readinessStatus, scrapedAt(sort: Desc)])
  @@map("client_profile_snapshots")
}

model ClientPostSnapshot {
  id                      String                @id @default(uuid())
  clientProfileSnapshotId String                @map("client_profile_snapshot_id")
  externalPostId          String                @map("external_post_id")
  postUrl                 String?               @map("post_url")
  caption                 String?
  format                  String?
  likesCount              Int?                  @map("likes_count")
  commentsCount           Int?                  @map("comments_count")
  sharesCount             Int?                  @map("shares_count")
  savesCount              Int?                  @map("saves_count")
  viewsCount              Int?                  @map("views_count")
  playsCount              Int?                  @map("plays_count")
  engagementRate          Float?                @map("engagement_rate")
  postedAt                DateTime?             @map("posted_at")
  scrapedAt               DateTime              @default(now()) @map("scraped_at")
  clientProfileSnapshot   ClientProfileSnapshot @relation(fields: [clientProfileSnapshotId], references: [id], onDelete: Cascade)
  mediaAssets             MediaAsset[]

  @@unique([clientProfileSnapshotId, externalPostId])
  @@map("client_post_snapshots")
}

model CompetitorProfile {
  id              String                      @id @default(uuid())
  competitorId    String                      @map("competitor_id")
  platform        String
  handle          String
  profileUrl      String?                     @map("profile_url")
  followerCount   Int?                        @map("follower_count")
  followingCount  Int?                        @map("following_count")
  bio             String?
  profileImageUrl String?                     @map("profile_image_url")
  isVerified      Boolean                     @default(false) @map("is_verified")
  isPrivate       Boolean                     @default(false) @map("is_private")
  lastScrapedAt   DateTime?                   @map("last_scraped_at")
  createdAt       DateTime                    @default(now()) @map("created_at")
  updatedAt       DateTime                    @updatedAt @map("updated_at")
  snapshots       CompetitorProfileSnapshot[]
  competitor      Competitor                  @relation(fields: [competitorId], references: [id], onDelete: Cascade)

  @@unique([competitorId, platform, handle])
  @@map("competitor_profiles")
}

model CompetitorProfileSnapshot {
  id                          String                   @id @default(uuid())
  competitorProfileId         String                   @map("competitor_profile_id")
  researchJobId               String?                  @map("research_job_id")
  followerCount               Int?                     @map("follower_count")
  followingCount              Int?                     @map("following_count")
  bio                         String?
  profileImageUrl             String?                  @map("profile_image_url")
  postsCount                  Int?                     @map("posts_count")
  isVerified                  Boolean                  @default(false) @map("is_verified")
  isPrivate                   Boolean                  @default(false) @map("is_private")
  readinessScore              Float?                   @map("readiness_score")
  readinessStatus             String?                  @map("readiness_status")
  readinessReasons            Json?                    @map("readiness_reasons")
  lastReadinessAt             DateTime?                @map("last_readiness_at")
  lastMediaDownloadQueuedAt   DateTime?                @map("last_media_download_queued_at")
  runId                       String?                  @map("run_id")
  orchestrationState          Json?                    @map("orchestration_state")
  scrapedAt                   DateTime                 @default(now()) @map("scraped_at")
  createdAt                   DateTime                 @default(now()) @map("created_at")
  updatedAt                   DateTime                 @updatedAt @map("updated_at")
  posts                       CompetitorPostSnapshot[]
  competitorProfile           CompetitorProfile        @relation(fields: [competitorProfileId], references: [id], onDelete: Cascade)
  researchJob                 ResearchJob?             @relation(fields: [researchJobId], references: [id])

  @@index([researchJobId])
  @@index([researchJobId, readinessStatus, scrapedAt(sort: Desc)])
  @@map("competitor_profile_snapshots")
}

model CompetitorPostSnapshot {
  id                          String                    @id @default(uuid())
  competitorProfileSnapshotId String                    @map("competitor_profile_snapshot_id")
  externalPostId              String                    @map("external_post_id")
  postUrl                     String?                   @map("post_url")
  caption                     String?
  format                      String?
  likesCount                  Int?                      @map("likes_count")
  commentsCount               Int?                      @map("comments_count")
  sharesCount                 Int?                      @map("shares_count")
  savesCount                  Int?                      @map("saves_count")
  viewsCount                  Int?                      @map("views_count")
  playsCount                  Int?                      @map("plays_count")
  engagementRate              Float?                    @map("engagement_rate")
  postedAt                    DateTime?                 @map("posted_at")
  scrapedAt                   DateTime                  @default(now()) @map("scraped_at")
  competitorProfileSnapshot   CompetitorProfileSnapshot @relation(fields: [competitorProfileSnapshotId], references: [id], onDelete: Cascade)
  mediaAssets                 MediaAsset[]

  @@unique([competitorProfileSnapshotId, externalPostId])
  @@map("competitor_post_snapshots")
}

model BrandMention {
  id                     String                       @id @default(uuid())
  clientId               String                       @map("client_id")
  url                    String
  title                  String?
  snippet                String?
  fullText               String?                      @map("full_text")
  sourceType             String?                      @map("source_type")
  scrapedAt              DateTime                     @default(now()) @map("scraped_at")
  brandIntelligenceRunId String?                      @map("brand_intelligence_run_id")
  availabilityStatus     CompetitorAvailabilityStatus @default(UNVERIFIED) @map("availability_status")
  availabilityReason     String?                      @map("availability_reason")
  resolverConfidence     Float?                       @map("resolver_confidence")
  evidence               Json?
  isActive               Boolean                      @default(true) @map("is_active")
  archivedAt             DateTime?                    @map("archived_at")
  archivedBy             String?                      @map("archived_by")
  manuallyModified       Boolean                      @default(false) @map("manually_modified")
  lastModifiedAt         DateTime?                    @map("last_modified_at")
  lastModifiedBy         String?                      @map("last_modified_by")
  updatedAt              DateTime                     @updatedAt @map("updated_at")
  aiAnalyses             AiAnalysis[]
  brandIntelligenceRun   BrandIntelligenceRun?        @relation(fields: [brandIntelligenceRunId], references: [id])
  client                 Client                       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([brandIntelligenceRunId])
  @@map("brand_mentions")
}

model AiAnalysis {
  id                    String          @id @default(uuid())
  researchJobId         String?         @map("research_job_id")
  clientPostId          String?         @map("client_post_id")
  cleanedPostId         String?         @map("cleaned_post_id")
  mediaAssetId          String?         @map("media_asset_id")
  clientDocumentId      String?         @map("client_document_id")
  brandMentionId        String?         @map("brand_mention_id")
  analysisType          AnalysisType    @map("analysis_type")
  modelUsed             String?         @map("model_used")
  topic                 String?
  contentPillarDetected String?         @map("content_pillar_detected")
  keywordsHooks         String?         @map("keywords_hooks")
  painPointAddressed    String?         @map("pain_point_addressed")
  goalAddressed         String?         @map("goal_addressed")
  visualStyleNotes      String?         @map("visual_style_notes")
  hookAnalysis          String?         @map("hook_analysis")
  fullResponse          Json?           @map("full_response")
  documentStatus        String?         @map("document_status")
  groundingReport       Json?           @map("grounding_report")
  confidenceScore       Float?          @map("confidence_score")
  tokensUsed            Int?            @map("tokens_used")
  analyzedAt            DateTime        @default(now()) @map("analyzed_at")
  brandMention          BrandMention?   @relation(fields: [brandMentionId], references: [id], onDelete: Cascade)
  cleanedPost           CleanedPost?    @relation(fields: [cleanedPostId], references: [id], onDelete: Cascade)
  clientDocument        ClientDocument? @relation(fields: [clientDocumentId], references: [id], onDelete: Cascade)
  clientPost            ClientPost?     @relation(fields: [clientPostId], references: [id], onDelete: Cascade)
  mediaAsset            MediaAsset?     @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
  researchJob           ResearchJob?    @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@map("ai_analyses")
}

model ContentPillar {
  id                  String          @id @default(uuid())
  clientId            String          @map("client_id")
  name                String
  purpose             String?
  rationale           String?
  emotionalConnection String?         @map("emotional_connection")
  addressesPainPoints String?         @map("addresses_pain_points")
  client              Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  pillarExamples      PillarExample[]
  formats             Format[]        @relation("PillarFormats")

  @@map("content_pillars")
}

model PillarExample {
  id            String        @id @default(uuid())
  pillarId      String        @map("pillar_id")
  cleanedPostId String?       @map("cleaned_post_id")
  topicHook     String?       @map("topic_hook")
  cleanedPost   CleanedPost?  @relation(fields: [cleanedPostId], references: [id])
  pillar        ContentPillar @relation(fields: [pillarId], references: [id], onDelete: Cascade)

  @@map("pillar_examples")
}

model Format {
  id                  String          @id @default(uuid())
  name                String          @unique
  description         String?
  purpose             String?
  pros                String?
  cons                String?
  expectedPerformance String?         @map("expected_performance")
  clientRequirements  String?         @map("client_requirements")
  pillars             ContentPillar[] @relation("PillarFormats")

  @@map("formats")
}

model BuyerJourneyStage {
  id                 String  @id @default(uuid())
  clientId           String  @map("client_id")
  stageName          String  @map("stage_name")
  stageOrder         Int     @map("stage_order")
  questions          String?
  actions            String?
  relevantPillars    Json?   @map("relevant_pillars")
  recommendedFormats Json?   @map("recommended_formats")
  client             Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("buyer_journey_stages")
}

model PlatformStrategy {
  id             String  @id @default(uuid())
  clientId       String  @map("client_id")
  platformName   String  @map("platform_name")
  isPrimary      Boolean @default(false) @map("is_primary")
  reason         String?
  focus          String?
  repostStrategy String? @map("repost_strategy")
  kpis           Json?
  client         Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("platform_strategies")
}

model MonitoringLog {
  id              String   @id @default(uuid())
  clientId        String   @map("client_id")
  lastMonitoredAt DateTime @map("last_monitored_at")
  profilesScraped Int      @default(0) @map("profiles_scraped")
  postsDiscovered Int      @default(0) @map("posts_discovered")
  errors          Json?
  status          String   @default("SUCCESS")
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("monitoring_logs")
}

enum ResearchJobStatus {
  PENDING
  SCRAPING_CLIENT
  DISCOVERING_COMPETITORS
  SCRAPING_COMPETITORS
  ANALYZING
  COMPLETE
  FAILED
}

enum AiQuestionType {
  VALUE_PROPOSITION
  TARGET_AUDIENCE
  CONTENT_PILLARS
  BRAND_VOICE
  BRAND_PERSONALITY
  COMPETITOR_ANALYSIS
  NICHE_POSITION
  UNIQUE_STRENGTHS
  CONTENT_OPPORTUNITIES
  GROWTH_STRATEGY
  PAIN_POINTS
  KEY_DIFFERENTIATORS
  CUSTOM
  COMPETITOR_DISCOVERY_METHOD
}

enum DocumentType {
  BUSINESS_PLAN
  VISION_DOC
  BRAND_GUIDELINES
  INTAKE_FORM
  OTHER
}

enum WebSourceType {
  CLIENT_SITE
  COMPETITOR_SITE
  ARTICLE
  REVIEW
  FORUM
  DOC
  OTHER
}

enum WebSourceDiscoveryMethod {
  DDG
  USER
  SCRAPLING_CRAWL
  CHAT_TOOL
  IMPORT
}

enum WebFetcherMode {
  AUTO
  HTTP
  DYNAMIC
  STEALTH
}

enum DiscoveredCompetitorStatus {
  SUGGESTED
  SCRAPING
  SCRAPED
  FAILED
  CONFIRMED
  REJECTED
}

enum CompetitorSelectionState {
  FILTERED_OUT
  SHORTLISTED
  TOP_PICK
  APPROVED
  REJECTED
}

enum CompetitorType {
  DIRECT
  INDIRECT
  ADJACENT
  MARKETPLACE
  MEDIA
  INFLUENCER
  COMMUNITY
  UNKNOWN
}

enum CompetitorAvailabilityStatus {
  UNVERIFIED
  VERIFIED
  PROFILE_UNAVAILABLE
  INVALID_HANDLE
  RATE_LIMITED
  CONNECTOR_ERROR
}

enum CompetitorCandidateState {
  DISCOVERED
  FILTERED_OUT
  SHORTLISTED
  TOP_PICK
  APPROVED
  REJECTED
}

enum CompetitorEntityType {
  BUSINESS
  PERSON
  PRODUCT
  ORG
}

enum CompetitorRelationshipType {
  DIRECT
  INDIRECT
  SUBSTITUTE
  INSPIRATION
  COMPLEMENT
}

enum CompetitorEntityStatus {
  ACTIVE
  ARCHIVED
}

enum CompetitorSurfaceType {
  WEBSITE
  INSTAGRAM
  TIKTOK
  YOUTUBE
  X
  LINKEDIN
  APP_STORE
  DIRECTORY
  OTHER
}

enum CompetitorScrapeCapability {
  SCRAPABLE_NOW
  NOT_SCRAPABLE_YET
  HARD_BLOCKED
}

enum EvidenceRefKind {
  WEB_SNAPSHOT
  WEB_EXTRACTION
  URL
  DOCUMENT
  CRAWL_RUN
  SOCIAL_POST
  NEWS_ITEM
  OTHER
}

enum BrainCommandStatus {
  PENDING
  APPLIED
  REJECTED
  FAILED
}

enum BrainProfileSuggestionStatus {
  PENDING
  ACCEPTED
  REJECTED
  APPROVED
}

enum BrainCommandType {
  ADD_COMPETITOR
  REMOVE_COMPETITOR
  UPDATE_GOAL
  UPDATE_CONTEXT
  UPDATE_SECTION_DATA
  RUN_SECTION
}

enum OrchestrationStepStatus {
  PENDING
  RUNNING
  DONE
  FAILED
  SKIPPED
}

enum RawPostStatus {
  PENDING
  PROCESSING
  CLEANED
  FAILED
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
}

enum MediaSourceType {
  CLIENT_POST_SNAPSHOT
  COMPETITOR_POST_SNAPSHOT
}

enum AnalysisType {
  CONTENT
  VISUAL
  VISUAL_COMPARISON
  AUDIO
  CAPTION
  OVERALL
  DOCUMENT
}

enum MediaAnalysisRunStatus {
  RUNNING
  COMPLETE
  SKIPPED
  FAILED
}

model MediaAnalysisRun {
  id                String                 @id @default(uuid())
  researchJobId     String                 @map("research_job_id")
  status            MediaAnalysisRunStatus @default(RUNNING)
  allowDegraded     Boolean                @default(false) @map("allow_degraded")
  skipAlreadyAnalyzed Boolean              @default(true) @map("skip_already_analyzed")
  requestedLimit    Int                    @map("requested_limit")
  maxEligibleAssets Int                    @map("max_eligible_assets")
  maxEligiblePosts  Int                    @map("max_eligible_posts")
  downloadedTotal   Int                    @default(0) @map("downloaded_total")
  qualifiedForAi    Int                    @default(0) @map("qualified_for_ai")
  analysisWindow    Int                    @default(0) @map("analysis_window")
  analyzedInWindow  Int                    @default(0) @map("analyzed_in_window")
  attemptedAssets   Int                    @default(0) @map("attempted_assets")
  succeededCount    Int                    @default(0) @map("succeeded_count")
  failedCount       Int                    @default(0) @map("failed_count")
  skippedReason     String?                @map("skipped_reason")
  diagnostics       Json?
  startedAt         DateTime               @default(now()) @map("started_at")
  completedAt       DateTime?              @map("completed_at")

  researchJob ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId, startedAt(sort: Desc)])
  @@index([researchJobId, status, startedAt(sort: Desc)])
  @@map("media_analysis_runs")
}

// ============================================
// CONTENT CALENDAR SYSTEM
// ============================================

model ContentCalendarRun {
  id                  String                @id @default(uuid())
  researchJobId       String                @map("research_job_id")
  weekStart           DateTime              @map("week_start")
  timezone            String                @default("Africa/Cairo")
  calendarBriefJson   Json                  @map("calendar_brief_json")
  contentCalendarJson Json                  @map("content_calendar_json")
  status              ContentCalendarStatus @default(RUNNING)
  errorMessage        String?               @map("error_message")
  diagnostics         Json?
  createdAt           DateTime              @default(now()) @map("created_at")
  completedAt         DateTime?             @map("completed_at")

  researchJob  ResearchJob           @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  slots        CalendarSlot[]
  chatSessions CalendarChatSession[]

  @@index([researchJobId, weekStart])
  @@map("content_calendar_runs")
}

enum ContentCalendarStatus {
  RUNNING
  COMPLETE
  FAILED
}

model CalendarSlot {
  id                  String             @id @default(uuid())
  calendarRunId       String             @map("calendar_run_id")
  slotIndex           Int                @map("slot_index")
  platform            String
  contentType         String             @map("content_type")
  scheduledAt         DateTime           @map("scheduled_at")
  theme               String?
  pillarId            String?            @map("pillar_id")
  objective           String?
  productionBriefJson Json               @map("production_brief_json")
  generationPlanJson  Json               @map("generation_plan_json")
  inspirationPostIds  String[]           @map("inspiration_post_ids")
  status              CalendarSlotStatus @default(PLANNED)
  blockReason         String?            @map("block_reason")
  createdAt           DateTime           @default(now()) @map("created_at")

  calendarRun ContentCalendarRun @relation(fields: [calendarRunId], references: [id], onDelete: Cascade)
  drafts      ContentDraft[]

  @@unique([calendarRunId, slotIndex])
  @@index([calendarRunId, status])
  @@map("calendar_slots")
}

enum CalendarSlotStatus {
  PLANNED
  BLOCKED
  READY_TO_GENERATE
  GENERATING
  DRAFT_CREATED
  APPROVED
}

model ContentDraft {
  id                     String             @id @default(uuid())
  slotId                 String             @map("slot_id")
  version                Int
  status                 ContentDraftStatus @default(DRAFT)
  caption                String?
  scriptJson             Json?              @map("script_json")
  assetsJson             Json?              @map("assets_json")
  usedInspirationPostIds String[]           @map("used_inspiration_post_ids")
  generationParams       Json?              @map("generation_params")
  errorMessage           String?            @map("error_message")
  createdAt              DateTime           @default(now()) @map("created_at")
  approvedAt             DateTime?          @map("approved_at")

  slot     CalendarSlot    @relation(fields: [slotId], references: [id], onDelete: Cascade)
  feedback DraftFeedback[]

  @@unique([slotId, version])
  @@index([slotId, status])
  @@map("content_drafts")
}

enum ContentDraftStatus {
  DRAFT
  AWAITING_FEEDBACK
  APPROVED
  FAILED
}

model DraftFeedback {
  id         String             @id @default(uuid())
  draftId    String             @map("draft_id")
  authorType FeedbackAuthorType @map("author_type")
  text       String
  createdAt  DateTime           @default(now()) @map("created_at")

  draft ContentDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId, createdAt])
  @@map("draft_feedback")
}

enum FeedbackAuthorType {
  CLIENT
  INTERNAL
}

// ============================================
// CHAT INTERFACE FOR CALENDAR
// ============================================

model CalendarChatSession {
  id            String                 @id @default(uuid())
  researchJobId String                 @map("research_job_id")
  entityType    CalendarChatEntityType @map("entity_type")
  entityId      String                 @map("entity_id")
  title         String?
  status        CalendarChatStatus     @default(ACTIVE)
  createdAt     DateTime               @default(now()) @map("created_at")
  lastMessageAt DateTime               @default(now()) @map("last_message_at")
  closedAt      DateTime?              @map("closed_at")

  researchJob          ResearchJob           @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  messages             CalendarChatMessage[]
  commands             CalendarChatCommand[]
  contentCalendarRun   ContentCalendarRun?   @relation(fields: [contentCalendarRunId], references: [id])
  contentCalendarRunId String?

  @@index([researchJobId, entityType, entityId])
  @@index([researchJobId, status, lastMessageAt(sort: Desc)])
  @@map("calendar_chat_sessions")
}

enum CalendarChatEntityType {
  CALENDAR_RUN
  CALENDAR_SLOT
  CONTENT_DRAFT
}

enum CalendarChatStatus {
  ACTIVE
  RESOLVED
  ARCHIVED
}

model CalendarChatMessage {
  id        String           @id @default(uuid())
  sessionId String           @map("session_id")
  role      CalendarChatRole
  content   String
  metadata  Json?
  createdAt DateTime         @default(now()) @map("created_at")

  session CalendarChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("calendar_chat_messages")
}

enum CalendarChatRole {
  USER
  ASSISTANT
  SYSTEM
}

// ============================================
// CHAT INTERFACE FOR WORKSPACE
// ============================================

model ChatSession {
  id            String   @id @default(uuid())
  researchJobId String   @map("research_job_id")
  title         String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  lastActiveAt  DateTime @default(now()) @map("last_active_at")

  researchJob ResearchJob    @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]
  blockEvents ChatBlockEvent[]
  savedBlocks ChatSavedBlock[]
  mutations   ChatMutation[]

  @@index([researchJobId, lastActiveAt(sort: Desc)])
  @@map("chat_sessions")
}

model ChatThread {
  id             String     @id @default(uuid())
  researchJobId  String     @map("research_job_id")
  title          String
  pinnedBranchId String?    @map("pinned_branch_id")
  archivedAt     DateTime?  @map("archived_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  researchJob   ResearchJob        @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  pinnedBranch  ChatBranch?        @relation("ChatThreadPinnedBranch", fields: [pinnedBranchId], references: [id], onDelete: SetNull)
  branches      ChatBranch[]

  @@index([researchJobId, updatedAt(sort: Desc)])
  @@index([pinnedBranchId])
  @@map("chat_threads")
}

enum ChatBranchStatus {
  ACTIVE
  ARCHIVED
}

model ChatBranch {
  id                  String           @id @default(uuid())
  threadId            String           @map("thread_id")
  name                String
  createdBy           String           @map("created_by")
  forkedFromMessageId String?          @map("forked_from_message_id")
  forkedFromBranchId  String?          @map("forked_from_branch_id")
  status              ChatBranchStatus @default(ACTIVE)
  createdAt           DateTime         @default(now()) @map("created_at")

  thread             ChatThread          @relation(fields: [threadId], references: [id], onDelete: Cascade)
  forkedFromMessage  ChatBranchMessage?  @relation("ChatBranchForkedMessage", fields: [forkedFromMessageId], references: [id], onDelete: SetNull)
  forkedFromBranch   ChatBranch?         @relation("ChatBranchForkSource", fields: [forkedFromBranchId], references: [id], onDelete: SetNull)
  forkChildren       ChatBranch[]        @relation("ChatBranchForkSource")
  pinnedByThreads    ChatThread[]        @relation("ChatThreadPinnedBranch")
  messages           ChatBranchMessage[]
  runs               AgentRun[]
  processEvents      ProcessEvent[]
  queueItems         MessageQueueItem[]

  @@index([threadId, createdAt(sort: Desc)])
  @@index([threadId, status, createdAt(sort: Desc)])
  @@index([forkedFromMessageId])
  @@index([forkedFromBranchId])
  @@map("chat_branches")
}

enum ChatBranchMessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

model ChatBranchMessage {
  id              String                @id @default(uuid())
  branchId        String                @map("branch_id")
  role            ChatBranchMessageRole
  content         String
  blocksJson      Json?                 @map("blocks_json")
  citationsJson   Json?                 @map("citations_json")
  reasoningJson   Json?                 @map("reasoning_json")
  parentMessageId String?               @map("parent_message_id")
  clientVisible   Boolean               @default(true) @map("client_visible")
  createdAt       DateTime              @default(now()) @map("created_at")

  branch         ChatBranch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  parentMessage  ChatBranchMessage?  @relation("ChatBranchMessageParent", fields: [parentMessageId], references: [id], onDelete: SetNull)
  childMessages  ChatBranchMessage[] @relation("ChatBranchMessageParent")
  forkedBranches ChatBranch[]        @relation("ChatBranchForkedMessage")
  triggerRuns    AgentRun[]          @relation("AgentRunTriggerMessage")

  @@index([branchId, createdAt])
  @@index([branchId, role, createdAt(sort: Desc)])
  @@index([parentMessageId])
  @@map("chat_branch_messages")
}

enum AgentRunTriggerType {
  USER_MESSAGE
  TOOL_RESULT
  SCHEDULED_LOOP
  MUTATION_APPLIED
  MANUAL_RETRY
}

enum AgentRunStatus {
  QUEUED
  RUNNING
  WAITING_TOOLS
  WAITING_USER
  DONE
  FAILED
  CANCELLED
}

model AgentRun {
  id               String              @id @default(uuid())
  branchId         String              @map("branch_id")
  triggerType      AgentRunTriggerType @map("trigger_type")
  triggerMessageId String?             @map("trigger_message_id")
  status           AgentRunStatus      @default(QUEUED)
  policyJson       Json?               @map("policy_json")
  planJson         Json?               @map("plan_json")
  startedAt        DateTime?           @map("started_at")
  endedAt          DateTime?           @map("ended_at")
  error            String?
  createdAt        DateTime            @default(now()) @map("created_at")

  branch         ChatBranch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  triggerMessage ChatBranchMessage? @relation("AgentRunTriggerMessage", fields: [triggerMessageId], references: [id], onDelete: SetNull)
  toolRuns       ToolRun[]
  processEvents  ProcessEvent[]

  @@index([branchId, createdAt(sort: Desc)])
  @@index([branchId, status, createdAt(sort: Desc)])
  @@index([triggerMessageId])
  @@map("agent_runs")
}

enum ToolRunStatus {
  QUEUED
  RUNNING
  DONE
  FAILED
  CANCELLED
}

model ToolRun {
  id                   String        @id @default(uuid())
  agentRunId           String        @map("agent_run_id")
  toolName             String        @map("tool_name")
  argsJson             Json          @map("args_json")
  status               ToolRunStatus @default(QUEUED)
  resultJson           Json?         @map("result_json")
  startedAt            DateTime?     @map("started_at")
  endedAt              DateTime?     @map("ended_at")
  costJson             Json?         @map("cost_json")
  producedArtifactsJson Json?        @map("produced_artifacts_json")
  createdAt            DateTime      @default(now()) @map("created_at")

  agentRun      AgentRun       @relation(fields: [agentRunId], references: [id], onDelete: Cascade)
  processEvents ProcessEvent[]

  @@index([agentRunId, createdAt])
  @@index([agentRunId, status, createdAt(sort: Desc)])
  @@map("tool_runs")
}

enum ProcessEventLevel {
  INFO
  WARN
  ERROR
}

enum ProcessEventType {
  PROCESS_STARTED
  PROCESS_PROGRESS
  PROCESS_LOG
  PROCESS_RESULT
  DECISION_REQUIRED
  WAITING_FOR_INPUT
  DONE
  FAILED
  PROCESS_CANCELLED
}

model ProcessEvent {
  id         String            @id @default(uuid())
  agentRunId String?           @map("agent_run_id")
  toolRunId  String?           @map("tool_run_id")
  branchId   String            @map("branch_id")
  level      ProcessEventLevel @default(INFO)
  type       ProcessEventType
  message    String
  payloadJson Json?            @map("payload_json")
  createdAt  DateTime          @default(now()) @map("created_at")

  branch   ChatBranch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  agentRun AgentRun?   @relation(fields: [agentRunId], references: [id], onDelete: SetNull)
  toolRun  ToolRun?    @relation(fields: [toolRunId], references: [id], onDelete: SetNull)

  @@index([branchId, createdAt])
  @@index([agentRunId, createdAt])
  @@index([toolRunId, createdAt])
  @@map("process_events")
}

enum MessageQueueItemStatus {
  QUEUED
  SENT
  CANCELLED
}

model MessageQueueItem {
  id        String                 @id @default(uuid())
  branchId  String                 @map("branch_id")
  userId    String                 @map("user_id")
  content   String
  position  Int
  status    MessageQueueItemStatus @default(QUEUED)
  createdAt DateTime               @default(now()) @map("created_at")

  branch ChatBranch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId, status, position])
  @@index([branchId, createdAt])
  @@map("message_queue_items")
}

enum ChatMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model ChatMessage {
  id            String          @id @default(uuid())
  sessionId     String          @map("session_id")
  role          ChatMessageRole
  content       String
  blocks        Json?
  designOptions Json?           @map("design_options")
  followUp      Json?           @map("follow_up")
  createdAt     DateTime        @default(now()) @map("created_at")

  session     ChatSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  blockEvents ChatBlockEvent[]
  savedBlocks ChatSavedBlock[]
  fileAttachments FileAttachment[]

  @@index([sessionId, createdAt])
  @@map("chat_messages")
}


enum ChatBlockEventType {
  VIEW
  PIN
  UNPIN
  SELECT_DESIGN
  FORM_SUBMIT
  ATTACH_VIEW
}

model ChatBlockEvent {
  id        String             @id @default(uuid())
  sessionId String             @map("session_id")
  messageId String             @map("message_id")
  blockId   String             @map("block_id")
  eventType ChatBlockEventType @map("event_type")
  payload   Json?
  createdAt DateTime           @default(now()) @map("created_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([messageId, blockId])
  @@index([blockId])
  @@map("chat_block_events")
}

model ChatSavedBlock {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  blockId   String   @map("block_id")
  messageId String   @map("message_id")
  blockData Json     @map("block_data")
  createdAt DateTime @default(now()) @map("created_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([sessionId, blockId])
  @@index([sessionId, createdAt])
  @@map("chat_saved_blocks")
}

enum ChatMutationKind {
  CREATE
  UPDATE
  DELETE
  CLEAR
}

model ChatMutation {
  id            String           @id @default(uuid())
  researchJobId String           @map("research_job_id")
  sessionId     String           @map("session_id")
  kind          ChatMutationKind
  section       String
  requestJson   Json             @map("request_json")
  previewJson   Json             @map("preview_json")
  createdAt     DateTime         @default(now()) @map("created_at")
  appliedAt     DateTime?        @map("applied_at")
  undoneAt      DateTime?        @map("undone_at")
  researchJob   ResearchJob      @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  session       ChatSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  undoSnapshots ChatMutationUndoSnapshot[]

  @@index([researchJobId, createdAt(sort: Desc)])
  @@index([sessionId, createdAt(sort: Desc)])
  @@map("chat_mutations")
}

model ChatMutationUndoSnapshot {
  id         String       @id @default(uuid())
  mutationId String       @map("mutation_id")
  modelName  String       @map("model_name")
  recordId   String       @map("record_id")
  beforeJson Json         @map("before_json")
  createdAt  DateTime     @default(now()) @map("created_at")
  mutation   ChatMutation @relation(fields: [mutationId], references: [id], onDelete: Cascade)

  @@index([mutationId])
  @@index([modelName, recordId])
  @@map("chat_mutation_undo_snapshots")
}

// Stores answers to the client questioning workflow
model ClientIntakeAnswer {
  id            String      @id @default(uuid())
  researchJobId String      @map("research_job_id")
  questionSetId String      @map("question_set_id")
  questionKey   String      @map("question_key")
  answerType    String      @map("answer_type")
  answer        Json
  triggeredBy   String?     @map("triggered_by")
  createdAt     DateTime    @default(now()) @map("created_at")
  researchJob   ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId, questionSetId])
  @@map("client_intake_answers")
}

// Tracks screenshots pasted into the chat with metadata about what they reference
model ScreenshotAttachment {
  id              String      @id @default(uuid())
  researchJobId   String      @map("research_job_id")
  chatMessageId   String?     @map("chat_message_id")
  storagePath     String      @map("storage_path")
  mimeType        String      @default("image/png") @map("mime_type")
  fileSizeBytes   Int?        @map("file_size_bytes")
  isAppScreenshot Boolean     @default(false) @map("is_app_screenshot")
  recordType      String?     @map("record_type")
  recordId        String?     @map("record_id")
  ocrText         String?     @map("ocr_text")
  aiSummary       String?     @map("ai_summary")
  createdAt       DateTime    @default(now()) @map("created_at")
  researchJob     ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId])
  @@map("screenshot_attachments")
}

model FileAttachment {
  id            String      @id @default(uuid())
  researchJobId String      @map("research_job_id")
  chatMessageId String?     @map("chat_message_id")
  fileName      String      @map("file_name")
  storagePath   String      @map("storage_path")
  mimeType      String      @map("mime_type")
  fileSizeBytes Int?        @map("file_size_bytes")
  createdAt     DateTime    @default(now()) @map("created_at")
  researchJob   ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  chatMessage   ChatMessage? @relation(fields: [chatMessageId], references: [id], onDelete: SetNull)

  @@index([researchJobId])
  @@index([chatMessageId])
  @@map("file_attachments")
}

model CalendarChatCommand {
  id            String                 @id @default(uuid())
  sessionId     String                 @map("session_id")
  entityType    CalendarChatEntityType @map("entity_type")
  entityId      String                 @map("entity_id")
  commandType   CalendarCommandType    @map("command_type")
  instruction   String
  proposedPatch Json                   @map("proposed_patch")
  appliedPatch  Json?                  @map("applied_patch")
  status        CalendarCommandStatus  @default(PENDING)
  replyText     String?                @map("reply_text")
  error         String?
  createdAt     DateTime               @default(now()) @map("created_at")
  appliedAt     DateTime?              @map("applied_at")

  session CalendarChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, status, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@map("calendar_chat_commands")
}

enum CalendarCommandType {
  UPDATE_SLOT_BRIEF
  UPDATE_DRAFT_CAPTION
  UPDATE_DRAFT_SCRIPT
  REGENERATE_DRAFT
  RESCHEDULE_SLOT
  CHANGE_INSPIRATION
  UPDATE_PRODUCTION_PARAMS
}

enum CalendarCommandStatus {
  PENDING
  APPROVED
  APPLIED
  REJECTED
  FAILED
}

model StrategyDocChatSession {
  id            String                @id @default(uuid())
  researchJobId String                @map("research_job_id")
  scope         StrategyDocChatScope  @default(ALL)
  sectionKey    String?               @map("section_key")
  title         String?
  status        StrategyDocChatStatus @default(ACTIVE)
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")
  lastMessageAt DateTime              @default(now()) @map("last_message_at")

  researchJob ResearchJob              @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  messages    StrategyDocChatMessage[]

  @@index([researchJobId, status, lastMessageAt(sort: Desc)])
  @@index([researchJobId, scope, sectionKey])
  @@map("strategy_doc_chat_sessions")
}

enum StrategyDocChatScope {
  ALL
  SECTION
}

enum StrategyDocChatStatus {
  ACTIVE
  ARCHIVED
}

model StrategyDocChatMessage {
  id            String             @id @default(uuid())
  sessionId     String             @map("session_id")
  role          StrategyDocChatRole
  content       String
  contextSnippet Json?             @map("context_snippet")
  createdAt     DateTime           @default(now()) @map("created_at")

  session StrategyDocChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("strategy_doc_chat_messages")
}

enum StrategyDocChatRole {
  USER
  ASSISTANT
  SYSTEM
}

/// Persistent facts the user provides during chat sessions.
/// Injected into every RAG call as the highest-priority context block.
model UserSuppliedContext {
  id            String      @id @default(uuid())
  researchJobId String      @map("research_job_id")
  category      String      // "website" | "social_profile" | "fact" | "correction" | "document_url" | "free_text"
  key           String      // natural dedup key within category (e.g. domain name, platform_handle)
  value         String      // the actual data value
  label         String?     // human-readable display label
  sourceMessage String?     @map("source_message") // original user message that triggered saving
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  researchJob   ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@unique([researchJobId, category, key])
  @@index([researchJobId, isActive])
  @@map("user_supplied_contexts")
}
